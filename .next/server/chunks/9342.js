"use strict";exports.id=9342,exports.ids=[9342],exports.modules={75637:(e,t,a)=>{a.r(t),a.d(t,{File:()=>y,Mod:()=>f,Post:()=>p,Thread:()=>c,User:()=>m,UserProfile:()=>h});var i=a(11185),o=a.n(i);let n=new(o()).Schema({email:{type:String,required:!0,unique:!0,lowercase:!0,trim:!0},password:{type:String,required:!0},name:{type:String,default:"Anonymous"},createdAt:{type:Date,default:Date.now}},{timestamps:!0}),r=new(o()).Schema({id:{type:String,required:!0,unique:!0},threadId:{type:String,required:!0,index:!0},content:{type:String,default:null},imageFileId:{type:o().Schema.Types.ObjectId,ref:"File",default:null},videoFileId:{type:o().Schema.Types.ObjectId,ref:"File",default:null},authorId:{type:String,required:!0},isAnonymous:{type:Boolean,default:!0},timestamp:{type:Date,default:Date.now,index:!0}},{timestamps:!0}),d=new(o()).Schema({id:{type:String,required:!0,unique:!0},slug:{type:String,required:!0,unique:!0,index:!0},title:{type:String,required:!0},opPostId:{type:String,required:!0},authorId:{type:String,required:!0},replyCount:{type:Number,default:0},imageCount:{type:Number,default:0},videoCount:{type:Number,default:0},lastActivity:{type:Date,default:Date.now,index:!0},createdAt:{type:Date,default:Date.now,index:!0}},{timestamps:!0}),l=new(o()).Schema({filename:{type:String,required:!0},contentType:{type:String,required:!0},size:{type:Number,required:!0},uploadedAt:{type:Date,default:Date.now,index:!0},uploadedBy:{type:String,required:!0},gridFSFileId:{type:o().Schema.Types.ObjectId,required:!0},isDeleted:{type:Boolean,default:!1}},{timestamps:!0}),s=new(o()).Schema({walletAddress:{type:String,required:!0,unique:!0,index:!0},username:{type:String,default:null,maxlength:50},location:{type:String,default:null,maxlength:100},socialLinks:{x:{type:String,default:null},youtube:{type:String,default:null}},bio:{type:String,default:null,maxlength:500},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}},{timestamps:!0}),u=new(o()).Schema({walletAddress:{type:String,required:!0,unique:!0,index:!0},addedBy:{type:String,required:!0},addedAt:{type:Date,default:Date.now}},{timestamps:!0}),m=o().models.User||o().model("User",n),c=o().models.Thread||o().model("Thread",d),p=o().models.Post||o().model("Post",r),y=o().models.File||o().model("File",l),h=o().models.UserProfile||o().model("UserProfile",s),f=o().models.Mod||o().model("Mod",u)},14184:(e,t,a)=>{let i;a.d(t,{ZP:()=>u,rW:()=>s});var o=a(38013);let n=process.env.MONGODB_URI||"mongodb://localhost:27017",r=null,d=null;async function l(){return d||(d=(await i).db()),d}async function s(){if(!r){let e=await l();r=new o.GridFSBucket(e,{bucketName:"files"})}return r}let u=i=new o.MongoClient(n,{}).connect()},29342:(e,t,a)=>{a.d(t,{G8:()=>c,Ho:()=>y,Ij:()=>m,OL:()=>h,Oo:()=>u,WN:()=>f,gK:()=>p,ky:()=>w});var i=a(14184),o=a(75637),n=a(60255),r=a(11185),d=a.n(r),l=a(76162);async function s(){if(!d().connections[0].readyState){if(!process.env.MONGODB_URI)throw Error("MONGODB_URI is not defined");await d().connect(process.env.MONGODB_URI)}}async function u(){await s();let e=await o.Thread.find({}).sort({createdAt:-1}).limit(100).lean(),t=new Set,a=await Promise.all(e.map(async e=>{let a=await o.Post.findOne({id:e.opPostId}).lean();return a?.authorId&&t.add(a.authorId),{thread:e,opPost:a}})),i=new Map;if(t.size>0)try{(await (0,n.U8)(Array.from(t))).forEach(e=>{i.set(e.walletAddress,e.username||"Anonymous")})}catch(e){console.error("Error fetching profiles:",e)}return{threads:a.map(({thread:e,opPost:t})=>{let a=t?.authorId&&i.get(t.authorId)||"Anonymous";return{...e,op:t?{id:t.id,content:t.content||null,image:t.imageFileId?`/api/files/${t.imageFileId}`:void 0,imageThumb:t.imageFileId?`/api/files/${t.imageFileId}`:void 0,video:t.videoFileId?`/api/files/${t.videoFileId}`:void 0,authorWallet:t.authorId||"anonymous",authorDisplayName:a,timestamp:t.timestamp||e.createdAt,isAnonymous:!1!==t.isAnonymous}:{id:`fallback_${e.id}`,content:null,image:void 0,imageThumb:void 0,video:void 0,authorWallet:"anonymous",authorDisplayName:"Anonymous",timestamp:e.createdAt||new Date,isAnonymous:!0}}}),totalThreads:e.length,lastUpdated:new Date().toISOString()}}async function m(e){await s();let t=await o.Thread.findOne({id:e}).lean();if(!t)return null;let a=await o.Post.findOne({id:t.opPostId}).lean(),i=await o.Post.find({threadId:e}).sort({timestamp:1}).lean(),r=new Set;a?.authorId&&r.add(a.authorId),i.forEach(e=>{e.authorId&&r.add(e.authorId)});let d=new Map;if(r.size>0)try{(await (0,n.U8)(Array.from(r))).forEach(e=>{d.set(e.walletAddress,e.username||"Anonymous")})}catch(e){console.error("Error fetching profiles:",e)}let l=a?.authorId&&d.get(a.authorId)||"Anonymous";return{...t,op:a?{id:a.id,content:a.content||null,image:a.imageFileId?`/api/files/${a.imageFileId}`:void 0,imageThumb:a.imageFileId?`/api/files/${a.imageFileId}`:void 0,video:a.videoFileId?`/api/files/${a.videoFileId}`:void 0,authorWallet:a.authorId||"anonymous",authorDisplayName:l,timestamp:a.timestamp||t.createdAt,isAnonymous:!1!==a.isAnonymous}:{id:`fallback_${t.id}`,content:null,image:void 0,imageThumb:void 0,video:void 0,authorWallet:"anonymous",authorDisplayName:"Anonymous",timestamp:t.createdAt||new Date,isAnonymous:!0},replies:i.map(e=>({id:e.id,timestamp:e.timestamp,content:e.content,image:e.imageFileId?`/api/files/${e.imageFileId}`:void 0,video:e.videoFileId?`/api/files/${e.videoFileId}`:void 0,authorWallet:e.authorId||"anonymous",authorDisplayName:e.authorId&&d.get(e.authorId)||"Anonymous",isAnonymous:e.isAnonymous,mediaFiles:[]}))}}async function c(e){await s();let t=await o.Thread.findOne({slug:e}).lean();if(!t)return null;let a=await o.Post.findOne({id:t.opPostId}).lean(),i=await o.Post.find({threadId:t.id}).sort({timestamp:1}).lean(),r=new Set;a?.authorId&&r.add(a.authorId),i.forEach(e=>{e.authorId&&r.add(e.authorId)});let d=new Map;if(r.size>0)try{(await (0,n.U8)(Array.from(r))).forEach(e=>{d.set(e.walletAddress,e.username||"Anonymous")})}catch(e){console.error("Error fetching profiles:",e)}let l=a?.authorId&&d.get(a.authorId)||"Anonymous";return{thread:{...t,op:a?{id:a.id,content:a.content||null,image:a.imageFileId?`/api/files/${a.imageFileId}`:void 0,imageThumb:a.imageFileId?`/api/files/${a.imageFileId}`:void 0,video:a.videoFileId?`/api/files/${a.videoFileId}`:void 0,authorWallet:a.authorId||"anonymous",authorDisplayName:l,timestamp:a.timestamp||t.createdAt,isAnonymous:!1!==a.isAnonymous}:{id:`fallback_${t.id}`,content:null,image:void 0,imageThumb:void 0,video:void 0,authorWallet:"anonymous",authorDisplayName:"Anonymous",timestamp:t.createdAt||new Date,isAnonymous:!0}},comments:i.map(e=>({id:e.id,timestamp:e.timestamp,content:e.content,image:e.imageFileId?`/api/files/${e.imageFileId}`:void 0,video:e.videoFileId?`/api/files/${e.videoFileId}`:void 0,authorWallet:e.authorId||"anonymous",authorDisplayName:e.authorId&&d.get(e.authorId)||"Anonymous",isAnonymous:e.isAnonymous,mediaFiles:[]}))}}async function p(e){await s();let t=`post_${Date.now()}_${Math.random().toString(36).substring(2,15)}`,a=e.op.image&&!e.op.image.startsWith("http")?e.op.image:null,i=e.op.video&&!e.op.video.startsWith("http")?e.op.video:null,n=new o.Post({id:t,threadId:e.id,content:e.op.content||null,imageFileId:a,videoFileId:i,authorId:e.authorId,isAnonymous:!0,timestamp:e.op.timestamp});await n.save();let r=new o.Thread({id:e.id,slug:e.slug,title:e.title,opPostId:t,authorId:e.authorId,replyCount:0,imageCount:a?1:0,videoCount:i?1:0,lastActivity:new Date,createdAt:new Date});await r.save();let d=await o.Thread.countDocuments({});if(d>100)for(let e of(await o.Thread.find({}).sort({createdAt:1}).limit(d-100).lean()))await o.Post.deleteMany({threadId:e.id}),await o.Thread.deleteOne({id:e.id});return r}async function y(e,t){await s();let a=t.image&&!t.image.startsWith("http")?t.image:null,i=t.video&&!t.video.startsWith("http")?t.video:null,n=new o.Post({id:t.id,threadId:e,content:t.content||null,imageFileId:a,videoFileId:i,authorId:t.authorId,isAnonymous:!0,timestamp:t.timestamp});await n.save();let r=await o.Thread.findOne({id:e});return r&&(r.replyCount=(r.replyCount||0)+1,a&&(r.imageCount=(r.imageCount||0)+1),i&&(r.videoCount=(r.videoCount||0)+1),r.lastActivity=new Date,await r.save()),n}async function h(e,t,a,n){let r;try{await s()}catch(e){throw console.error("MongoDB connection error:",e),Error(`Database connection failed: ${e instanceof Error?e.message:"Unknown error"}`)}try{r=await (0,i.rW)()}catch(e){throw console.error("GridFS bucket error:",e),Error(`Failed to get GridFS bucket: ${e instanceof Error?e.message:"Unknown error"}`)}let d=r.openUploadStream(t,{contentType:a});l.Readable.from(e).pipe(d),await new Promise((e,t)=>{d.on("finish",e),d.on("error",e=>{console.error("GridFS upload stream error:",e),t(Error(`GridFS upload failed: ${e.message}`))})});try{let i=new o.File({filename:t,contentType:a,size:e.length,uploadedAt:new Date,uploadedBy:n,gridFSFileId:d.id});return await i.save(),i._id.toString()}catch(e){console.error("File metadata save error:",e);try{await r.delete(d.id)}catch(e){console.error("Failed to clean up GridFS file after metadata save failure:",e)}throw Error(`Failed to save file metadata: ${e instanceof Error?e.message:"Unknown error"}`)}}async function f(e){await s();let t=await o.File.findOne({_id:e,isDeleted:!1});return(t||(t=await o.File.findOne({gridFSFileId:e,isDeleted:!1})),t)?{stream:(await (0,i.rW)()).openDownloadStream(t.gridFSFileId),contentType:t.contentType,filename:t.filename}:null}async function w(){await s();let e=new Date;e.setDate(e.getDate()-30);let t=await o.File.find({uploadedAt:{$lt:e},isDeleted:!1}),a=await (0,i.rW)(),n=0;for(let e of t)try{await a.delete(e.gridFSFileId),e.isDeleted=!0,await e.save(),n++}catch(t){console.error(`Failed to delete file ${e.gridFSFileId}:`,t)}return n}},60255:(e,t,a)=>{a.d(t,{Lj:()=>s,U8:()=>l,et:()=>d});var i=a(75637),o=a(11185),n=a.n(o);async function r(){if(!n().connections[0].readyState){if(!process.env.MONGODB_URI)throw Error("MONGODB_URI is not defined");await n().connect(process.env.MONGODB_URI)}}async function d(e){await r();let t=await i.UserProfile.findOne({walletAddress:e}).lean();return t?{walletAddress:t.walletAddress,username:t.username||null,location:t.location||null,socialLinks:{x:t.socialLinks?.x||null,youtube:t.socialLinks?.youtube||null},bio:t.bio||null}:{walletAddress:e,username:null,location:null,socialLinks:{x:null,youtube:null},bio:null}}async function l(e){await r();let t=await i.UserProfile.find({walletAddress:{$in:e}}).lean(),a=new Map;return t.forEach(e=>{a.set(e.walletAddress,{walletAddress:e.walletAddress,username:e.username||null,location:e.location||null,socialLinks:{x:e.socialLinks?.x||null,youtube:e.socialLinks?.youtube||null},bio:e.bio||null})}),e.map(e=>a.get(e)||{walletAddress:e,username:null,location:null,socialLinks:{x:null,youtube:null},bio:null})}async function s(e,t){if(await r(),void 0!==t.username){if(t.username&&t.username.length>50)throw Error("Username must be 50 characters or less");if(t.username&&await i.UserProfile.findOne({username:t.username,walletAddress:{$ne:e}}))throw Error("Username is already taken")}if(void 0!==t.location&&t.location&&t.location.length>100)throw Error("Location must be 100 characters or less");if(void 0!==t.bio&&t.bio&&t.bio.length>500)throw Error("Bio must be 500 characters or less");if(t.socialLinks){if(t.socialLinks.x&&!u(t.socialLinks.x,["x.com","twitter.com"]))throw Error("Invalid X.com URL");if(t.socialLinks.youtube&&!u(t.socialLinks.youtube,["youtube.com","youtu.be"]))throw Error("Invalid YouTube URL")}return await i.UserProfile.findOneAndUpdate({walletAddress:e},{...t,walletAddress:e,updatedAt:new Date},{upsert:!0,new:!0,setDefaultsOnInsert:!0})}function u(e,t){try{let a=new URL(e.startsWith("http")?e:`https://${e}`).hostname.toLowerCase();return t.some(e=>a===e||a.endsWith(`.${e}`))}catch{return!1}}}};