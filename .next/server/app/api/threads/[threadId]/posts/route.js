"use strict";(()=>{var e={};e.id=1009,e.ids=[1009],e.modules={38013:e=>{e.exports=require("mongodb")},11185:e=>{e.exports=require("mongoose")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},76162:e=>{e.exports=require("stream")},69702:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>v,patchFetch:()=>y,requestAsyncStorage:()=>f,routeModule:()=>h,serverHooks:()=>w,staticGenerationAsyncStorage:()=>g});var o={};r.r(o),r.d(o,{GET:()=>m,POST:()=>l,dynamic:()=>p});var a=r(49303),n=r(88716),s=r(60670),i=r(87070),d=r(57708),c=r(29342),u=r(90528);let p="force-dynamic";async function l(e,{params:t}){try{console.log("POST /api/threads/[threadId]/posts called with params:",t);let{threadId:r}=t,o=await e.json();console.log("Request body:",o);let{content:a,image:n,video:s,authorWallet:p,paymentSignature:l}=o;if(!p)return i.NextResponse.json({error:"Wallet connection required. Please connect your Solana wallet."},{status:401});if(!await (0,u.UY)(p)){if(!l)return i.NextResponse.json({error:"Payment required",requiresPayment:!0,amount:.01,message:"You must pay 0.01 USDC to post a comment. Admins and mods are exempt."},{status:402});try{let e=process.env.NEXT_PUBLIC_BASE_URL||(process.env.VERCEL_URL?`https://${process.env.VERCEL_URL}`:"http://localhost:3000"),t=await fetch(`${e}/api/payments/posting-fee?signature=${l}&fromWallet=${p}`);if(!(await t.json()).verified)return i.NextResponse.json({error:"Payment verification failed. Please try again."},{status:402})}catch(e){return console.error("Payment verification error:",e),i.NextResponse.json({error:"Payment verification failed. Please try again."},{status:402})}}if(!a&&!n&&!s)return i.NextResponse.json({error:"Please provide either a comment, image, or video"},{status:400});let m=e=>{if(e)return"string"==typeof e&&e.startsWith("/api/files/")?e.replace("/api/files/",""):e},h=m(n),f=m(s);if(!await (0,c.Ij)(r))return i.NextResponse.json({error:"Thread not found"},{status:404});let g=`post_${Date.now()}_${Math.random().toString(36).substring(2,15)}`,w={id:g,content:a||void 0,image:h||void 0,video:f||void 0,authorId:p,timestamp:new Date};console.log("Creating new comment:",w),console.log(`Adding comment to thread ${r} using MongoDB storage`);try{await (0,c.Ho)(r,w),console.log(`Comment added successfully to thread ${r}`)}catch(e){return console.error("CRITICAL: Failed to add comment to thread:",e),i.NextResponse.json({error:"Failed to add comment to thread"},{status:500})}return(0,d.revalidatePath)("/"),console.log(`Added comment to thread ${r} - ${new Date().toISOString()}`),i.NextResponse.json({success:!0,post:{id:g,content:w.content,image:w.image,video:w.video,timestamp:w.timestamp}})}catch(e){return console.error("Create post error:",e),i.NextResponse.json({error:"Failed to create post"},{status:500})}}async function m(e,{params:t}){try{console.log("GET /api/threads/[threadId]/posts called with params:",t);let{threadId:e}=t,r=await (0,c.Ij)(e);if(!r)return i.NextResponse.json({error:"Thread not found"},{status:404});return i.NextResponse.json({thread:{...r,replies:r.replies||[]}})}catch(e){return console.error("Get thread error:",e),i.NextResponse.json({error:"Failed to get thread"},{status:500})}}let h=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/threads/[threadId]/posts/route",pathname:"/api/threads/[threadId]/posts",filename:"route",bundlePath:"app/api/threads/[threadId]/posts/route"},resolvedPagePath:"/Users/meneer.groot/GitHub/LOOPCHAN/app/api/threads/[threadId]/posts/route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:f,staticGenerationAsyncStorage:g,serverHooks:w}=h,v="/api/threads/[threadId]/posts/route";function y(){return(0,s.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:g})}},90528:(e,t,r)=>{r.d(t,{GJ:()=>c,Jw:()=>l,UY:()=>p,bW:()=>h,j9:()=>s,md:()=>i,vg:()=>m});var o=r(75637),a=r(11185),n=r.n(a);let s="2sRhKuPffCwT2uuGVu3DXDsLFmjv78uKkEMd9UYrF5jv",i=.01;async function d(){if(!n().connections[0].readyState){if(!process.env.MONGODB_URI)throw Error("MONGODB_URI is not defined");await n().connect(process.env.MONGODB_URI)}}function c(e){return"2Z9eW3nwa2GZUM1JzXdfBK1MN57RPA2PrhuTREEZ31VY"===e}async function u(e){if(c(e))return!0;try{return await d(),!!await o.Mod.findOne({walletAddress:e}).lean()}catch(e){return console.error("Error checking if wallet is mod:",e),!1}}async function p(e){return c(e)||await u(e)}async function l(){return await d(),await o.Mod.find({}).sort({addedAt:-1}).lean()}async function m(e,t){if(await d(),await o.Mod.findOne({walletAddress:e}))throw Error("Wallet is already a mod");let r=new o.Mod({walletAddress:e,addedBy:t});return await r.save(),r}async function h(e){if(await d(),c(e))throw Error("Cannot remove admin");return(await o.Mod.deleteOne({walletAddress:e})).deletedCount>0}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[9276,5972,7708,9342],()=>r(69702));module.exports=o})();