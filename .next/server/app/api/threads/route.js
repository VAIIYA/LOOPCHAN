"use strict";(()=>{var e={};e.id=5034,e.ids=[5034],e.modules={38013:e=>{e.exports=require("mongodb")},11185:e=>{e.exports=require("mongoose")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},80665:e=>{e.exports=require("dns")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},76162:e=>{e.exports=require("stream")},82452:e=>{e.exports=require("tls")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},54370:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>w,patchFetch:()=>v,requestAsyncStorage:()=>h,routeModule:()=>g,serverHooks:()=>f,staticGenerationAsyncStorage:()=>y});var r={};a.r(r),a.d(r,{GET:()=>m,POST:()=>c,dynamic:()=>p});var i=a(49303),o=a(88716),n=a(60670),s=a(87070),d=a(95456),l=a(29342),u=a(57708);let p="force-dynamic";async function c(e){try{let t=await (0,d.I8)();if(!t||!t.user?.id)return s.NextResponse.json({error:"Authentication required"},{status:401});console.log("POST /api/threads called");let{title:a,content:r,image:i,video:o}=await e.json();if(console.log("Request body:",{title:a,hasContent:!!r,hasImage:!!i,hasVideo:!!o}),!a)return s.NextResponse.json({error:"Title is required"},{status:400});if(!r&&!i&&!o)return s.NextResponse.json({error:"Please provide either a comment, image, or video"},{status:400});let n=null;try{n=await (0,l.Oo)()}catch(e){console.error("Failed to load threads index:",e)}n||(n={threads:[],totalThreads:0,lastUpdated:new Date().toISOString()}),console.log(`Loaded ${n.threads.length} existing threads`);let p=`thread_${Date.now()}_${Math.random().toString(36).substring(2,15)}`,c=function(e,t){let a=t.toLowerCase().replace(/[^a-z0-9\s-]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-").trim().substring(0,50),r=a,i=1;for(;e.some(e=>e.slug===r);)r=`${a}-${i}`,i++;return r}(n.threads,a);console.log(`Generated slug for thread "${a}": ${c}`);let m={id:p,slug:c,title:a,op:{content:r||void 0,image:i||void 0,video:o||void 0,authorId:t.user.id,timestamp:new Date},authorId:t.user.id};console.log("Creating new thread with MongoDB storage");try{let e=await (0,l.gK)(m);return console.log(`Thread created successfully with slug "${c}" (ID: ${p})`),(0,u.revalidatePath)("/"),s.NextResponse.json({success:!0,thread:{id:e.id,slug:e.slug,title:e.title,replyCount:e.replyCount,imageCount:e.imageCount,videoCount:e.videoCount,createdAt:e.createdAt,lastActivity:e.lastActivity}})}catch(e){return console.error("CRITICAL: Failed to create thread:",e),s.NextResponse.json({success:!1,error:"Failed to create thread"},{status:500})}}catch(e){return console.error("Create thread error:",e),s.NextResponse.json({error:"Failed to create thread"},{status:500})}}async function m(e){try{let{searchParams:t}=new URL(e.url),a=parseInt(t.get("page")||"1"),r=t.get("slug");console.log("Fetching threads, page:",a,"slug:",r);let i=null;try{i=await (0,l.Oo)()}catch(e){return console.error("Thread list API: Failed to load threads from MongoDB:",e),s.NextResponse.json({error:"Failed to load threads data from storage"},{status:500})}if(console.log(`Thread list API: Loaded ${i?.threads?.length||0} threads from MongoDB`),!i||!i.threads)return console.log("No threads data found"),s.NextResponse.json({threads:[],page:1,totalPages:0,totalThreads:0});if(r){let e=i.threads.find(e=>e.slug===r);if(!e)return console.log(`Thread with slug "${r}" not found. Available slugs:`,i.threads.map(e=>e.slug||"no-slug")),s.NextResponse.json({error:"Thread not found"},{status:404});return console.log(`Found thread by slug: ${e.title} (${e.id})`),s.NextResponse.json({threads:[e],page:1,totalPages:1,totalThreads:1})}let o=i.threads.length,n=Math.ceil(o/20),d=(a-1)*20,u=i.threads.slice(d,d+20);return console.log(`Returning page ${a} of ${n} (${u.length} threads)`),console.log("Thread IDs on this page:",u.map(e=>e.id)),s.NextResponse.json({threads:u,page:a,totalPages:n,totalThreads:o})}catch(e){return console.error("Get threads error:",e),s.NextResponse.json({error:"Failed to get threads"},{status:500})}}let g=new i.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/threads/route",pathname:"/api/threads",filename:"route",bundlePath:"app/api/threads/route"},resolvedPagePath:"/Users/meneer.groot/GitHub/LOOPCHAN/app/api/threads/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:h,staticGenerationAsyncStorage:y,serverHooks:f}=g,w="/api/threads/route";function v(){return(0,n.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:y})}},95456:(e,t,a)=>{a.d(t,{I8:()=>g,handlers:()=>m});var r=a(68372),i=a(27600),o=a(22058),n=a(64704),s=a(14184),d=a(98691),l=a(75637),u=a(11185),p=a.n(u);async function c(){if(!p().connections[0].readyState){if(!process.env.MONGODB_URI)throw Error("MONGODB_URI is not defined");await p().connect(process.env.MONGODB_URI)}}let{handlers:m,auth:g,signIn:h,signOut:y}=(0,r.ZP)({adapter:(0,n.dJ)(s.ZP),providers:[(0,i.Z)({credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)return null;await c();let t="string"==typeof e.email?e.email.toLowerCase():String(e.email).toLowerCase(),a="string"==typeof e.password?e.password:String(e.password),r=await l.n5.findOne({email:t});return r&&await d.ZP.compare(a,r.password)?{id:r._id.toString(),email:r.email,name:r.name}:null}}),(0,o.Z)({server:{host:process.env.SMTP_HOST,port:Number(process.env.SMTP_PORT),auth:{user:process.env.SMTP_USER,pass:process.env.SMTP_PASSWORD}},from:process.env.SMTP_FROM||"noreply@loopchan.vercel.app"})],session:{strategy:"jwt"},pages:{signIn:"/auth/signin"},callbacks:{jwt:async({token:e,user:t})=>(t&&(e.id=t.id,e.email=t.email),e),session:async({session:e,token:t})=>(e.user&&(e.user.id=t.id),e)},secret:process.env.NEXTAUTH_SECRET})},75637:(e,t,a)=>{a.d(t,{$B:()=>c,SO:()=>p,jz:()=>u,n5:()=>l});var r=a(11185),i=a.n(r);let o=new(i()).Schema({email:{type:String,required:!0,unique:!0,lowercase:!0,trim:!0},password:{type:String,required:!0},name:{type:String,default:"Anonymous"},createdAt:{type:Date,default:Date.now}},{timestamps:!0}),n=new(i()).Schema({id:{type:String,required:!0,unique:!0},threadId:{type:String,required:!0,index:!0},content:{type:String,default:null},imageFileId:{type:i().Schema.Types.ObjectId,ref:"File",default:null},videoFileId:{type:i().Schema.Types.ObjectId,ref:"File",default:null},authorId:{type:i().Schema.Types.ObjectId,ref:"User",required:!0},isAnonymous:{type:Boolean,default:!0},timestamp:{type:Date,default:Date.now,index:!0}},{timestamps:!0}),s=new(i()).Schema({id:{type:String,required:!0,unique:!0},slug:{type:String,required:!0,unique:!0,index:!0},title:{type:String,required:!0},opPostId:{type:String,required:!0},authorId:{type:i().Schema.Types.ObjectId,ref:"User",required:!0},replyCount:{type:Number,default:0},imageCount:{type:Number,default:0},videoCount:{type:Number,default:0},lastActivity:{type:Date,default:Date.now,index:!0},createdAt:{type:Date,default:Date.now,index:!0}},{timestamps:!0}),d=new(i()).Schema({filename:{type:String,required:!0},contentType:{type:String,required:!0},size:{type:Number,required:!0},uploadedAt:{type:Date,default:Date.now,index:!0},uploadedBy:{type:i().Schema.Types.ObjectId,ref:"User",required:!0},gridFSFileId:{type:i().Schema.Types.ObjectId,required:!0},isDeleted:{type:Boolean,default:!1}},{timestamps:!0}),l=i().models.User||i().model("User",o),u=i().models.Thread||i().model("Thread",s),p=i().models.Post||i().model("Post",n),c=i().models.File||i().model("File",d)},14184:(e,t,a)=>{let r;a.d(t,{ZP:()=>u,rW:()=>l});var i=a(38013);let o=process.env.MONGODB_URI||"mongodb://localhost:27017",n=null,s=null;async function d(){return s||(s=(await r).db()),s}async function l(){if(!n){let e=await d();n=new i.GridFSBucket(e,{bucketName:"files"})}return n}let u=r=new i.MongoClient(o,{}).connect()},29342:(e,t,a)=>{a.d(t,{Ho:()=>c,Ij:()=>u,OL:()=>m,Oo:()=>l,WN:()=>g,gK:()=>p,ky:()=>h});var r=a(14184),i=a(75637),o=a(11185),n=a.n(o),s=a(76162);async function d(){if(!n().connections[0].readyState){if(!process.env.MONGODB_URI)throw Error("MONGODB_URI is not defined");await n().connect(process.env.MONGODB_URI)}}async function l(){await d();let e=await i.jz.find({}).sort({createdAt:-1}).limit(100).lean();return{threads:await Promise.all(e.map(async e=>{let t=await i.SO.findOne({id:e.opPostId}).lean();return{...e,op:t?{content:t.content||null,image:t.imageFileId?`/api/files/${t.imageFileId}`:void 0,video:t.videoFileId?`/api/files/${t.videoFileId}`:void 0,authorWallet:"anonymous",timestamp:t.timestamp}:null}})),totalThreads:e.length,lastUpdated:new Date().toISOString()}}async function u(e){await d();let t=await i.jz.findOne({id:e}).lean();if(!t)return null;let a=await i.SO.findOne({id:t.opPostId}).lean(),r=await i.SO.find({threadId:e}).sort({timestamp:1}).lean();return{...t,op:a?{content:a.content,image:a.imageFileId?`/api/files/${a.imageFileId}`:void 0,video:a.videoFileId?`/api/files/${a.videoFileId}`:void 0,authorWallet:"anonymous",timestamp:a.timestamp}:null,replies:r.map(e=>({id:e.id,timestamp:e.timestamp,content:e.content,image:e.imageFileId?`/api/files/${e.imageFileId}`:void 0,video:e.videoFileId?`/api/files/${e.videoFileId}`:void 0,authorWallet:"anonymous",isAnonymous:e.isAnonymous,mediaFiles:[]}))}}async function p(e){await d();let t=`post_${Date.now()}_${Math.random().toString(36).substring(2,15)}`,a=new i.SO({id:t,threadId:e.id,content:e.op.content||null,imageFileId:e.op.image||null,videoFileId:e.op.video||null,authorId:e.authorId,isAnonymous:!0,timestamp:e.op.timestamp});await a.save();let r=new i.jz({id:e.id,slug:e.slug,title:e.title,opPostId:t,authorId:e.authorId,replyCount:0,imageCount:e.op.image?1:0,videoCount:e.op.video?1:0,lastActivity:new Date,createdAt:new Date});await r.save();let o=await i.jz.countDocuments({});if(o>100)for(let e of(await i.jz.find({}).sort({createdAt:1}).limit(o-100).lean()))await i.SO.deleteMany({threadId:e.id}),await i.jz.deleteOne({id:e.id});return r}async function c(e,t){await d();let a=new i.SO({id:t.id,threadId:e,content:t.content||null,imageFileId:t.image||null,videoFileId:t.video||null,authorId:t.authorId,isAnonymous:!0,timestamp:t.timestamp});await a.save();let r=await i.jz.findOne({id:e});return r&&(r.replyCount=(r.replyCount||0)+1,t.image&&(r.imageCount=(r.imageCount||0)+1),t.video&&(r.videoCount=(r.videoCount||0)+1),r.lastActivity=new Date,await r.save()),a}async function m(e,t,a,o){await d();let n=(await (0,r.rW)()).openUploadStream(t,{contentType:a});s.Readable.from(e).pipe(n),await new Promise((e,t)=>{n.on("finish",e),n.on("error",t)});let l=new i.$B({filename:t,contentType:a,size:e.length,uploadedAt:new Date,uploadedBy:o,gridFSFileId:n.id});return await l.save(),l._id.toString()}async function g(e){await d();let t=await i.$B.findOne({_id:e,isDeleted:!1});return(t||(t=await i.$B.findOne({gridFSFileId:e,isDeleted:!1})),t)?{stream:(await (0,r.rW)()).openDownloadStream(t.gridFSFileId),contentType:t.contentType,filename:t.filename}:null}async function h(){await d();let e=new Date;e.setDate(e.getDate()-30);let t=await i.$B.find({uploadedAt:{$lt:e},isDeleted:!1}),a=await (0,r.rW)(),o=0;for(let e of t)try{await a.delete(e.gridFSFileId),e.isDeleted=!0,await e.save(),o++}catch(t){console.error(`Failed to delete file ${e.gridFSFileId}:`,t)}return o}}};var t=require("../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[9276,5972,8691,2694,7708],()=>a(54370));module.exports=r})();