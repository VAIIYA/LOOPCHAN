"use strict";(()=>{var e={};e.id=5034,e.ids=[5034],e.modules={38013:e=>{e.exports=require("mongodb")},11185:e=>{e.exports=require("mongoose")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},76162:e=>{e.exports=require("stream")},54370:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>y,patchFetch:()=>v,requestAsyncStorage:()=>f,routeModule:()=>p,serverHooks:()=>w,staticGenerationAsyncStorage:()=>m});var o={};r.r(o),r.d(o,{GET:()=>g,POST:()=>h,dynamic:()=>c});var a=r(49303),s=r(88716),n=r(60670),i=r(87070),d=r(29342),l=r(90528),u=r(57708);let c="force-dynamic";async function h(e){try{let{title:t,content:r,image:o,video:a,authorWallet:s,paymentSignature:n}=await e.json();if(!s)return i.NextResponse.json({error:"Wallet connection required. Please connect your Solana wallet."},{status:401});if(console.log("POST /api/threads called"),!await (0,l.UY)(s)){if(!n)return i.NextResponse.json({error:"Payment required",requiresPayment:!0,amount:.01,message:"You must pay 0.01 USDC to create a thread. Admins and mods are exempt."},{status:402});try{let e=process.env.NEXT_PUBLIC_BASE_URL||(process.env.VERCEL_URL?`https://${process.env.VERCEL_URL}`:"http://localhost:3000"),t=await fetch(`${e}/api/payments/posting-fee?signature=${n}&fromWallet=${s}`);if(!(await t.json()).verified)return i.NextResponse.json({error:"Payment verification failed. Please try again."},{status:402})}catch(e){return console.error("Payment verification error:",e),i.NextResponse.json({error:"Payment verification failed. Please try again."},{status:402})}}if(console.log("Request body:",{title:t,hasContent:!!r,hasImage:!!o,hasVideo:!!a}),!t)return i.NextResponse.json({error:"Title is required"},{status:400});if(!r&&!o&&!a)return i.NextResponse.json({error:"Please provide either a comment, image, or video"},{status:400});let c=e=>{if(e)return e.startsWith("/api/files/")?e.replace("/api/files/",""):e},h=c(o),g=c(a),p=null;try{p=await (0,d.Oo)()}catch(e){console.error("Failed to load threads index:",e)}p||(p={threads:[],totalThreads:0,lastUpdated:new Date().toISOString()}),console.log(`Loaded ${p.threads.length} existing threads`);let f=`thread_${Date.now()}_${Math.random().toString(36).substring(2,15)}`,m=function(e,t){let r=t.toLowerCase().replace(/[^a-z0-9\s-]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-").trim().substring(0,50),o=r,a=1;for(;e.some(e=>e.slug===o);)o=`${r}-${a}`,a++;return o}(p.threads,t);console.log(`Generated slug for thread "${t}": ${m}`);let w={id:f,slug:m,title:t,op:{content:r||void 0,image:h||void 0,video:g||void 0,authorId:s,timestamp:new Date},authorId:s};console.log("Creating new thread with MongoDB storage",{threadId:f,slug:m,title:t,hasContent:!!r,imageFileId:h,videoFileId:g,authorWallet:s});try{let e=await (0,d.gK)(w);return console.log(`Thread created successfully with slug "${m}" (ID: ${f})`),(0,u.revalidatePath)("/"),i.NextResponse.json({success:!0,thread:{id:e.id,slug:e.slug,title:e.title,replyCount:e.replyCount||0,imageCount:e.imageCount||0,videoCount:e.videoCount||0,createdAt:e.createdAt,lastActivity:e.lastActivity}})}catch(r){console.error("CRITICAL: Failed to create thread:",r);let e=r instanceof Error?r.message:"Unknown error",t=r instanceof Error?r.stack:void 0;return console.error("Error details:",{errorMessage:e,errorStack:t,newThreadData:w}),i.NextResponse.json({success:!1,error:"Failed to create thread",details:void 0},{status:500})}}catch(e){return console.error("Create thread error:",e),i.NextResponse.json({error:"Failed to create thread"},{status:500})}}async function g(e){try{let{searchParams:t}=new URL(e.url),r=parseInt(t.get("page")||"1"),o=t.get("slug");console.log("Fetching threads, page:",r,"slug:",o);let a=null;try{a=await (0,d.Oo)()}catch(e){return console.error("Thread list API: Failed to load threads from MongoDB:",e),i.NextResponse.json({error:"Failed to load threads data from storage"},{status:500})}if(console.log(`Thread list API: Loaded ${a?.threads?.length||0} threads from MongoDB`),!a||!a.threads)return console.log("No threads data found"),i.NextResponse.json({threads:[],page:1,totalPages:0,totalThreads:0});if(o){let e=a.threads.find(e=>e.slug===o);if(!e)return console.log(`Thread with slug "${o}" not found. Available slugs:`,a.threads.map(e=>e.slug||"no-slug")),i.NextResponse.json({error:"Thread not found"},{status:404});return console.log(`Found thread by slug: ${e.title} (${e.id})`),i.NextResponse.json({threads:[e],page:1,totalPages:1,totalThreads:1})}let s=a.threads.length,n=Math.ceil(s/20),l=(r-1)*20,u=a.threads.slice(l,l+20);return console.log(`Returning page ${r} of ${n} (${u.length} threads)`),console.log("Thread IDs on this page:",u.map(e=>e.id)),i.NextResponse.json({threads:u,page:r,totalPages:n,totalThreads:s})}catch(e){return console.error("Get threads error:",e),i.NextResponse.json({error:"Failed to get threads"},{status:500})}}let p=new a.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/threads/route",pathname:"/api/threads",filename:"route",bundlePath:"app/api/threads/route"},resolvedPagePath:"/Users/meneer.groot/GitHub/LOOPCHAN/app/api/threads/route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:f,staticGenerationAsyncStorage:m,serverHooks:w}=p,y="/api/threads/route";function v(){return(0,n.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:m})}},90528:(e,t,r)=>{r.d(t,{GJ:()=>l,Jw:()=>h,UY:()=>c,bW:()=>p,j9:()=>n,md:()=>i,vg:()=>g});var o=r(75637),a=r(11185),s=r.n(a);let n="2sRhKuPffCwT2uuGVu3DXDsLFmjv78uKkEMd9UYrF5jv",i=.01;async function d(){if(!s().connections[0].readyState){if(!process.env.MONGODB_URI)throw Error("MONGODB_URI is not defined");await s().connect(process.env.MONGODB_URI)}}function l(e){return"2Z9eW3nwa2GZUM1JzXdfBK1MN57RPA2PrhuTREEZ31VY"===e}async function u(e){if(l(e))return!0;try{return await d(),!!await o.Mod.findOne({walletAddress:e}).lean()}catch(e){return console.error("Error checking if wallet is mod:",e),!1}}async function c(e){return l(e)||await u(e)}async function h(){return await d(),await o.Mod.find({}).sort({addedAt:-1}).lean()}async function g(e,t){if(await d(),await o.Mod.findOne({walletAddress:e}))throw Error("Wallet is already a mod");let r=new o.Mod({walletAddress:e,addedBy:t});return await r.save(),r}async function p(e){if(await d(),l(e))throw Error("Cannot remove admin");return(await o.Mod.deleteOne({walletAddress:e})).deletedCount>0}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[9276,5972,7708,9342],()=>r(54370));module.exports=o})();