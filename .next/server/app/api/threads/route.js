"use strict";(()=>{var e={};e.id=5034,e.ids=[5034],e.modules={38013:e=>{e.exports=require("mongodb")},11185:e=>{e.exports=require("mongoose")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},76162:e=>{e.exports=require("stream")},54370:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>y,patchFetch:()=>w,requestAsyncStorage:()=>g,routeModule:()=>m,serverHooks:()=>f,staticGenerationAsyncStorage:()=>h});var o={};a.r(o),a.d(o,{GET:()=>p,POST:()=>c,dynamic:()=>u});var r=a(49303),i=a(88716),n=a(60670),s=a(87070),d=a(29342),l=a(57708);let u="force-dynamic";async function c(e){try{let{title:t,content:a,image:o,video:r,authorWallet:i}=await e.json();if(!i)return s.NextResponse.json({error:"Wallet connection required. Please connect your Solana wallet."},{status:401});if(console.log("POST /api/threads called"),console.log("Request body:",{title:t,hasContent:!!a,hasImage:!!o,hasVideo:!!r}),!t)return s.NextResponse.json({error:"Title is required"},{status:400});if(!a&&!o&&!r)return s.NextResponse.json({error:"Please provide either a comment, image, or video"},{status:400});let n=e=>{if(e)return e.startsWith("/api/files/")?e.replace("/api/files/",""):e},u=n(o),c=n(r),p=null;try{p=await (0,d.Oo)()}catch(e){console.error("Failed to load threads index:",e)}p||(p={threads:[],totalThreads:0,lastUpdated:new Date().toISOString()}),console.log(`Loaded ${p.threads.length} existing threads`);let m=`thread_${Date.now()}_${Math.random().toString(36).substring(2,15)}`,g=function(e,t){let a=t.toLowerCase().replace(/[^a-z0-9\s-]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-").trim().substring(0,50),o=a,r=1;for(;e.some(e=>e.slug===o);)o=`${a}-${r}`,r++;return o}(p.threads,t);console.log(`Generated slug for thread "${t}": ${g}`);let h={id:m,slug:g,title:t,op:{content:a||void 0,image:u||void 0,video:c||void 0,authorId:i,timestamp:new Date},authorId:i};console.log("Creating new thread with MongoDB storage",{threadId:m,slug:g,title:t,hasContent:!!a,imageFileId:u,videoFileId:c,authorWallet:i});try{let e=await (0,d.gK)(h);return console.log(`Thread created successfully with slug "${g}" (ID: ${m})`),(0,l.revalidatePath)("/"),s.NextResponse.json({success:!0,thread:{id:e.id,slug:e.slug,title:e.title,replyCount:e.replyCount||0,imageCount:e.imageCount||0,videoCount:e.videoCount||0,createdAt:e.createdAt,lastActivity:e.lastActivity}})}catch(a){console.error("CRITICAL: Failed to create thread:",a);let e=a instanceof Error?a.message:"Unknown error",t=a instanceof Error?a.stack:void 0;return console.error("Error details:",{errorMessage:e,errorStack:t,newThreadData:h}),s.NextResponse.json({success:!1,error:"Failed to create thread",details:void 0},{status:500})}}catch(e){return console.error("Create thread error:",e),s.NextResponse.json({error:"Failed to create thread"},{status:500})}}async function p(e){try{let{searchParams:t}=new URL(e.url),a=parseInt(t.get("page")||"1"),o=t.get("slug");console.log("Fetching threads, page:",a,"slug:",o);let r=null;try{r=await (0,d.Oo)()}catch(e){return console.error("Thread list API: Failed to load threads from MongoDB:",e),s.NextResponse.json({error:"Failed to load threads data from storage"},{status:500})}if(console.log(`Thread list API: Loaded ${r?.threads?.length||0} threads from MongoDB`),!r||!r.threads)return console.log("No threads data found"),s.NextResponse.json({threads:[],page:1,totalPages:0,totalThreads:0});if(o){let e=r.threads.find(e=>e.slug===o);if(!e)return console.log(`Thread with slug "${o}" not found. Available slugs:`,r.threads.map(e=>e.slug||"no-slug")),s.NextResponse.json({error:"Thread not found"},{status:404});return console.log(`Found thread by slug: ${e.title} (${e.id})`),s.NextResponse.json({threads:[e],page:1,totalPages:1,totalThreads:1})}let i=r.threads.length,n=Math.ceil(i/20),l=(a-1)*20,u=r.threads.slice(l,l+20);return console.log(`Returning page ${a} of ${n} (${u.length} threads)`),console.log("Thread IDs on this page:",u.map(e=>e.id)),s.NextResponse.json({threads:u,page:a,totalPages:n,totalThreads:i})}catch(e){return console.error("Get threads error:",e),s.NextResponse.json({error:"Failed to get threads"},{status:500})}}let m=new r.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/threads/route",pathname:"/api/threads",filename:"route",bundlePath:"app/api/threads/route"},resolvedPagePath:"/Users/meneer.groot/GitHub/LOOPCHAN/app/api/threads/route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:g,staticGenerationAsyncStorage:h,serverHooks:f}=m,y="/api/threads/route";function w(){return(0,n.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:h})}},75637:(e,t,a)=>{a.r(t),a.d(t,{File:()=>p,Post:()=>c,Thread:()=>u,User:()=>l});var o=a(11185),r=a.n(o);let i=new(r()).Schema({email:{type:String,required:!0,unique:!0,lowercase:!0,trim:!0},password:{type:String,required:!0},name:{type:String,default:"Anonymous"},createdAt:{type:Date,default:Date.now}},{timestamps:!0}),n=new(r()).Schema({id:{type:String,required:!0,unique:!0},threadId:{type:String,required:!0,index:!0},content:{type:String,default:null},imageFileId:{type:r().Schema.Types.ObjectId,ref:"File",default:null},videoFileId:{type:r().Schema.Types.ObjectId,ref:"File",default:null},authorId:{type:String,required:!0},isAnonymous:{type:Boolean,default:!0},timestamp:{type:Date,default:Date.now,index:!0}},{timestamps:!0}),s=new(r()).Schema({id:{type:String,required:!0,unique:!0},slug:{type:String,required:!0,unique:!0,index:!0},title:{type:String,required:!0},opPostId:{type:String,required:!0},authorId:{type:String,required:!0},replyCount:{type:Number,default:0},imageCount:{type:Number,default:0},videoCount:{type:Number,default:0},lastActivity:{type:Date,default:Date.now,index:!0},createdAt:{type:Date,default:Date.now,index:!0}},{timestamps:!0}),d=new(r()).Schema({filename:{type:String,required:!0},contentType:{type:String,required:!0},size:{type:Number,required:!0},uploadedAt:{type:Date,default:Date.now,index:!0},uploadedBy:{type:String,required:!0},gridFSFileId:{type:r().Schema.Types.ObjectId,required:!0},isDeleted:{type:Boolean,default:!1}},{timestamps:!0}),l=r().models.User||r().model("User",i),u=r().models.Thread||r().model("Thread",s),c=r().models.Post||r().model("Post",n),p=r().models.File||r().model("File",d)},14184:(e,t,a)=>{let o;a.d(t,{ZP:()=>u,rW:()=>l});var r=a(38013);let i=process.env.MONGODB_URI||"mongodb://localhost:27017",n=null,s=null;async function d(){return s||(s=(await o).db()),s}async function l(){if(!n){let e=await d();n=new r.GridFSBucket(e,{bucketName:"files"})}return n}let u=o=new r.MongoClient(i,{}).connect()},29342:(e,t,a)=>{a.d(t,{G8:()=>c,Ho:()=>m,Ij:()=>u,OL:()=>g,Oo:()=>l,WN:()=>h,gK:()=>p,ky:()=>f});var o=a(14184),r=a(75637),i=a(11185),n=a.n(i),s=a(76162);async function d(){if(!n().connections[0].readyState){if(!process.env.MONGODB_URI)throw Error("MONGODB_URI is not defined");await n().connect(process.env.MONGODB_URI)}}async function l(){await d();let e=await r.Thread.find({}).sort({createdAt:-1}).limit(100).lean();return{threads:await Promise.all(e.map(async e=>{let t=await r.Post.findOne({id:e.opPostId}).lean();return{...e,op:t?{content:t.content||null,image:t.imageFileId?`/api/files/${t.imageFileId}`:void 0,video:t.videoFileId?`/api/files/${t.videoFileId}`:void 0,authorWallet:"anonymous",timestamp:t.timestamp}:null}})),totalThreads:e.length,lastUpdated:new Date().toISOString()}}async function u(e){await d();let t=await r.Thread.findOne({id:e}).lean();if(!t)return null;let a=await r.Post.findOne({id:t.opPostId}).lean(),o=await r.Post.find({threadId:e}).sort({timestamp:1}).lean();return{...t,op:a?{content:a.content,image:a.imageFileId?`/api/files/${a.imageFileId}`:void 0,video:a.videoFileId?`/api/files/${a.videoFileId}`:void 0,authorWallet:"anonymous",timestamp:a.timestamp}:null,replies:o.map(e=>({id:e.id,timestamp:e.timestamp,content:e.content,image:e.imageFileId?`/api/files/${e.imageFileId}`:void 0,video:e.videoFileId?`/api/files/${e.videoFileId}`:void 0,authorWallet:"anonymous",isAnonymous:e.isAnonymous,mediaFiles:[]}))}}async function c(e){await d();let t=await r.Thread.findOne({slug:e}).lean();if(!t)return null;let a=await r.Post.findOne({id:t.opPostId}).lean(),o=await r.Post.find({threadId:t.id}).sort({timestamp:1}).lean();return{thread:{...t,op:a?{content:a.content,image:a.imageFileId?`/api/files/${a.imageFileId}`:void 0,video:a.videoFileId?`/api/files/${a.videoFileId}`:void 0,authorWallet:"anonymous",timestamp:a.timestamp}:null},comments:o.map(e=>({id:e.id,timestamp:e.timestamp,content:e.content,image:e.imageFileId?`/api/files/${e.imageFileId}`:void 0,video:e.videoFileId?`/api/files/${e.videoFileId}`:void 0,authorWallet:"anonymous",isAnonymous:e.isAnonymous,mediaFiles:[]}))}}async function p(e){await d();let t=`post_${Date.now()}_${Math.random().toString(36).substring(2,15)}`,a=e.op.image&&!e.op.image.startsWith("http")?e.op.image:null,o=e.op.video&&!e.op.video.startsWith("http")?e.op.video:null,i=new r.Post({id:t,threadId:e.id,content:e.op.content||null,imageFileId:a,videoFileId:o,authorId:e.authorId,isAnonymous:!0,timestamp:e.op.timestamp});await i.save();let n=new r.Thread({id:e.id,slug:e.slug,title:e.title,opPostId:t,authorId:e.authorId,replyCount:0,imageCount:a?1:0,videoCount:o?1:0,lastActivity:new Date,createdAt:new Date});await n.save();let s=await r.Thread.countDocuments({});if(s>100)for(let e of(await r.Thread.find({}).sort({createdAt:1}).limit(s-100).lean()))await r.Post.deleteMany({threadId:e.id}),await r.Thread.deleteOne({id:e.id});return n}async function m(e,t){await d();let a=t.image&&!t.image.startsWith("http")?t.image:null,o=t.video&&!t.video.startsWith("http")?t.video:null,i=new r.Post({id:t.id,threadId:e,content:t.content||null,imageFileId:a,videoFileId:o,authorId:t.authorId,isAnonymous:!0,timestamp:t.timestamp});await i.save();let n=await r.Thread.findOne({id:e});return n&&(n.replyCount=(n.replyCount||0)+1,a&&(n.imageCount=(n.imageCount||0)+1),o&&(n.videoCount=(n.videoCount||0)+1),n.lastActivity=new Date,await n.save()),i}async function g(e,t,a,i){let n;try{await d()}catch(e){throw console.error("MongoDB connection error:",e),Error(`Database connection failed: ${e instanceof Error?e.message:"Unknown error"}`)}try{n=await (0,o.rW)()}catch(e){throw console.error("GridFS bucket error:",e),Error(`Failed to get GridFS bucket: ${e instanceof Error?e.message:"Unknown error"}`)}let l=n.openUploadStream(t,{contentType:a});s.Readable.from(e).pipe(l),await new Promise((e,t)=>{l.on("finish",e),l.on("error",e=>{console.error("GridFS upload stream error:",e),t(Error(`GridFS upload failed: ${e.message}`))})});try{let o=new r.File({filename:t,contentType:a,size:e.length,uploadedAt:new Date,uploadedBy:i,gridFSFileId:l.id});return await o.save(),o._id.toString()}catch(e){console.error("File metadata save error:",e);try{await n.delete(l.id)}catch(e){console.error("Failed to clean up GridFS file after metadata save failure:",e)}throw Error(`Failed to save file metadata: ${e instanceof Error?e.message:"Unknown error"}`)}}async function h(e){await d();let t=await r.File.findOne({_id:e,isDeleted:!1});return(t||(t=await r.File.findOne({gridFSFileId:e,isDeleted:!1})),t)?{stream:(await (0,o.rW)()).openDownloadStream(t.gridFSFileId),contentType:t.contentType,filename:t.filename}:null}async function f(){await d();let e=new Date;e.setDate(e.getDate()-30);let t=await r.File.find({uploadedAt:{$lt:e},isDeleted:!1}),a=await (0,o.rW)(),i=0;for(let e of t)try{await a.delete(e.gridFSFileId),e.isDeleted=!0,await e.save(),i++}catch(t){console.error(`Failed to delete file ${e.gridFSFileId}:`,t)}return i}}};var t=require("../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),o=t.X(0,[9276,5972,7708],()=>a(54370));module.exports=o})();