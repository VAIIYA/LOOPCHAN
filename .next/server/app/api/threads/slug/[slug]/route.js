"use strict";(()=>{var e={};e.id=3807,e.ids=[3807],e.modules={38013:e=>{e.exports=require("mongodb")},11185:e=>{e.exports=require("mongoose")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},76162:e=>{e.exports=require("stream")},4211:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>h,patchFetch:()=>y,requestAsyncStorage:()=>p,routeModule:()=>m,serverHooks:()=>g,staticGenerationAsyncStorage:()=>c});var i={};a.r(i),a.d(i,{GET:()=>u,dynamic:()=>s});var o=a(49303),n=a(88716),r=a(60670),d=a(87070),l=a(29342);let s="force-dynamic";async function u(e,{params:t}){try{let{slug:e}=t;console.log(`Fetching thread by slug: ${e}`);let a=null;try{a=await (0,l.G8)(e)}catch(e){return console.error("Failed to load thread data from MongoDB:",e),d.NextResponse.json({success:!1,error:"Failed to load thread data from storage"},{status:500})}if(a&&a.thread&&(console.log(`Slug lookup: Found thread "${a.thread.title}" with ${a.comments.length} comments`),console.log("Slug lookup: Thread reply IDs:",a.comments.map(e=>e.id))),console.log("DEBUG: Loaded thread data:",{hasData:!!a,hasThread:!!a?.thread,hasComments:!!a?.comments,commentCount:a?.comments?.length||0,threadTitle:a?.thread?.title}),!a||!a.thread)return console.log("No thread data found after retries"),d.NextResponse.json({success:!1,error:"No thread found"},{status:404});let{thread:i,comments:o}=a;return console.log(`Thread found: ${i.title} (${i.id})`),console.log(`Thread has ${o.length} comments`),console.log("Comment IDs:",o.map(e=>e.id)),console.log("Thread data structure:",{id:i.id,title:i.title,slug:i.slug,replyCount:i.replyCount,actualComments:o.length,lastReply:i.lastReply,lastActivity:i.lastActivity}),d.NextResponse.json({success:!0,thread:{id:i.id,slug:i.slug,title:i.title,op:i.op,replies:o,lastReply:i.lastReply,replyCount:i.replyCount||0,imageCount:i.imageCount||0,videoCount:i.videoCount||0,createdAt:i.createdAt,lastActivity:i.lastActivity,authorWallet:i.authorWallet}})}catch(e){return console.error("Error fetching thread by slug:",e),d.NextResponse.json({success:!1,error:"Failed to fetch thread"},{status:500})}}let m=new o.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/threads/slug/[slug]/route",pathname:"/api/threads/slug/[slug]",filename:"route",bundlePath:"app/api/threads/slug/[slug]/route"},resolvedPagePath:"/Users/meneer.groot/GitHub/LOOPCHAN/app/api/threads/slug/[slug]/route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:p,staticGenerationAsyncStorage:c,serverHooks:g}=m,h="/api/threads/slug/[slug]/route";function y(){return(0,r.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:c})}},75637:(e,t,a)=>{a.r(t),a.d(t,{File:()=>p,Post:()=>m,Thread:()=>u,User:()=>s});var i=a(11185),o=a.n(i);let n=new(o()).Schema({email:{type:String,required:!0,unique:!0,lowercase:!0,trim:!0},password:{type:String,required:!0},name:{type:String,default:"Anonymous"},createdAt:{type:Date,default:Date.now}},{timestamps:!0}),r=new(o()).Schema({id:{type:String,required:!0,unique:!0},threadId:{type:String,required:!0,index:!0},content:{type:String,default:null},imageFileId:{type:o().Schema.Types.ObjectId,ref:"File",default:null},videoFileId:{type:o().Schema.Types.ObjectId,ref:"File",default:null},authorId:{type:String,required:!0},isAnonymous:{type:Boolean,default:!0},timestamp:{type:Date,default:Date.now,index:!0}},{timestamps:!0}),d=new(o()).Schema({id:{type:String,required:!0,unique:!0},slug:{type:String,required:!0,unique:!0,index:!0},title:{type:String,required:!0},opPostId:{type:String,required:!0},authorId:{type:String,required:!0},replyCount:{type:Number,default:0},imageCount:{type:Number,default:0},videoCount:{type:Number,default:0},lastActivity:{type:Date,default:Date.now,index:!0},createdAt:{type:Date,default:Date.now,index:!0}},{timestamps:!0}),l=new(o()).Schema({filename:{type:String,required:!0},contentType:{type:String,required:!0},size:{type:Number,required:!0},uploadedAt:{type:Date,default:Date.now,index:!0},uploadedBy:{type:String,required:!0},gridFSFileId:{type:o().Schema.Types.ObjectId,required:!0},isDeleted:{type:Boolean,default:!1}},{timestamps:!0}),s=o().models.User||o().model("User",n),u=o().models.Thread||o().model("Thread",d),m=o().models.Post||o().model("Post",r),p=o().models.File||o().model("File",l)},14184:(e,t,a)=>{let i;a.d(t,{ZP:()=>u,rW:()=>s});var o=a(38013);let n=process.env.MONGODB_URI||"mongodb://localhost:27017",r=null,d=null;async function l(){return d||(d=(await i).db()),d}async function s(){if(!r){let e=await l();r=new o.GridFSBucket(e,{bucketName:"files"})}return r}let u=i=new o.MongoClient(n,{}).connect()},29342:(e,t,a)=>{a.d(t,{G8:()=>m,Ho:()=>c,Ij:()=>u,OL:()=>g,Oo:()=>s,WN:()=>h,gK:()=>p,ky:()=>y});var i=a(14184),o=a(75637),n=a(11185),r=a.n(n),d=a(76162);async function l(){if(!r().connections[0].readyState){if(!process.env.MONGODB_URI)throw Error("MONGODB_URI is not defined");await r().connect(process.env.MONGODB_URI)}}async function s(){await l();let e=await o.Thread.find({}).sort({createdAt:-1}).limit(100).lean();return{threads:await Promise.all(e.map(async e=>{let t=await o.Post.findOne({id:e.opPostId}).lean();return{...e,op:t?{id:t.id,content:t.content||null,image:t.imageFileId?`/api/files/${t.imageFileId}`:void 0,imageThumb:t.imageFileId?`/api/files/${t.imageFileId}`:void 0,video:t.videoFileId?`/api/files/${t.videoFileId}`:void 0,authorWallet:t.authorId||"anonymous",timestamp:t.timestamp||e.createdAt,isAnonymous:!1!==t.isAnonymous}:{id:`fallback_${e.id}`,content:null,image:void 0,imageThumb:void 0,video:void 0,authorWallet:"anonymous",timestamp:e.createdAt||new Date,isAnonymous:!0}}})),totalThreads:e.length,lastUpdated:new Date().toISOString()}}async function u(e){await l();let t=await o.Thread.findOne({id:e}).lean();if(!t)return null;let a=await o.Post.findOne({id:t.opPostId}).lean(),i=await o.Post.find({threadId:e}).sort({timestamp:1}).lean();return{...t,op:a?{id:a.id,content:a.content||null,image:a.imageFileId?`/api/files/${a.imageFileId}`:void 0,imageThumb:a.imageFileId?`/api/files/${a.imageFileId}`:void 0,video:a.videoFileId?`/api/files/${a.videoFileId}`:void 0,authorWallet:a.authorId||"anonymous",timestamp:a.timestamp||t.createdAt,isAnonymous:!1!==a.isAnonymous}:{id:`fallback_${t.id}`,content:null,image:void 0,imageThumb:void 0,video:void 0,authorWallet:"anonymous",timestamp:t.createdAt||new Date,isAnonymous:!0},replies:i.map(e=>({id:e.id,timestamp:e.timestamp,content:e.content,image:e.imageFileId?`/api/files/${e.imageFileId}`:void 0,video:e.videoFileId?`/api/files/${e.videoFileId}`:void 0,authorWallet:"anonymous",isAnonymous:e.isAnonymous,mediaFiles:[]}))}}async function m(e){await l();let t=await o.Thread.findOne({slug:e}).lean();if(!t)return null;let a=await o.Post.findOne({id:t.opPostId}).lean(),i=await o.Post.find({threadId:t.id}).sort({timestamp:1}).lean();return{thread:{...t,op:a?{content:a.content,image:a.imageFileId?`/api/files/${a.imageFileId}`:void 0,video:a.videoFileId?`/api/files/${a.videoFileId}`:void 0,authorWallet:"anonymous",timestamp:a.timestamp}:null},comments:i.map(e=>({id:e.id,timestamp:e.timestamp,content:e.content,image:e.imageFileId?`/api/files/${e.imageFileId}`:void 0,video:e.videoFileId?`/api/files/${e.videoFileId}`:void 0,authorWallet:"anonymous",isAnonymous:e.isAnonymous,mediaFiles:[]}))}}async function p(e){await l();let t=`post_${Date.now()}_${Math.random().toString(36).substring(2,15)}`,a=e.op.image&&!e.op.image.startsWith("http")?e.op.image:null,i=e.op.video&&!e.op.video.startsWith("http")?e.op.video:null,n=new o.Post({id:t,threadId:e.id,content:e.op.content||null,imageFileId:a,videoFileId:i,authorId:e.authorId,isAnonymous:!0,timestamp:e.op.timestamp});await n.save();let r=new o.Thread({id:e.id,slug:e.slug,title:e.title,opPostId:t,authorId:e.authorId,replyCount:0,imageCount:a?1:0,videoCount:i?1:0,lastActivity:new Date,createdAt:new Date});await r.save();let d=await o.Thread.countDocuments({});if(d>100)for(let e of(await o.Thread.find({}).sort({createdAt:1}).limit(d-100).lean()))await o.Post.deleteMany({threadId:e.id}),await o.Thread.deleteOne({id:e.id});return r}async function c(e,t){await l();let a=t.image&&!t.image.startsWith("http")?t.image:null,i=t.video&&!t.video.startsWith("http")?t.video:null,n=new o.Post({id:t.id,threadId:e,content:t.content||null,imageFileId:a,videoFileId:i,authorId:t.authorId,isAnonymous:!0,timestamp:t.timestamp});await n.save();let r=await o.Thread.findOne({id:e});return r&&(r.replyCount=(r.replyCount||0)+1,a&&(r.imageCount=(r.imageCount||0)+1),i&&(r.videoCount=(r.videoCount||0)+1),r.lastActivity=new Date,await r.save()),n}async function g(e,t,a,n){let r;try{await l()}catch(e){throw console.error("MongoDB connection error:",e),Error(`Database connection failed: ${e instanceof Error?e.message:"Unknown error"}`)}try{r=await (0,i.rW)()}catch(e){throw console.error("GridFS bucket error:",e),Error(`Failed to get GridFS bucket: ${e instanceof Error?e.message:"Unknown error"}`)}let s=r.openUploadStream(t,{contentType:a});d.Readable.from(e).pipe(s),await new Promise((e,t)=>{s.on("finish",e),s.on("error",e=>{console.error("GridFS upload stream error:",e),t(Error(`GridFS upload failed: ${e.message}`))})});try{let i=new o.File({filename:t,contentType:a,size:e.length,uploadedAt:new Date,uploadedBy:n,gridFSFileId:s.id});return await i.save(),i._id.toString()}catch(e){console.error("File metadata save error:",e);try{await r.delete(s.id)}catch(e){console.error("Failed to clean up GridFS file after metadata save failure:",e)}throw Error(`Failed to save file metadata: ${e instanceof Error?e.message:"Unknown error"}`)}}async function h(e){await l();let t=await o.File.findOne({_id:e,isDeleted:!1});return(t||(t=await o.File.findOne({gridFSFileId:e,isDeleted:!1})),t)?{stream:(await (0,i.rW)()).openDownloadStream(t.gridFSFileId),contentType:t.contentType,filename:t.filename}:null}async function y(){await l();let e=new Date;e.setDate(e.getDate()-30);let t=await o.File.find({uploadedAt:{$lt:e},isDeleted:!1}),a=await (0,i.rW)(),n=0;for(let e of t)try{await a.delete(e.gridFSFileId),e.isDeleted=!0,await e.save(),n++}catch(t){console.error(`Failed to delete file ${e.gridFSFileId}:`,t)}return n}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),i=t.X(0,[9276,5972],()=>a(4211));module.exports=i})();