"use strict";(()=>{var e={};e.id=9479,e.ids=[9479],e.modules={38013:e=>{e.exports=require("mongodb")},11185:e=>{e.exports=require("mongoose")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},76162:e=>{e.exports=require("stream")},16105:(e,t,i)=>{i.r(t),i.d(t,{originalPathname:()=>f,patchFetch:()=>y,requestAsyncStorage:()=>p,routeModule:()=>u,serverHooks:()=>c,staticGenerationAsyncStorage:()=>m});var a={};i.r(a),i.d(a,{GET:()=>s});var n=i(49303),o=i(88716),r=i(60670),d=i(87070),l=i(29342);async function s(e,{params:t}){try{let{fileId:e}=t,i=await (0,l.WN)(e);if(!i)return d.NextResponse.json({error:"File not found"},{status:404});return new d.NextResponse(i.stream,{headers:{"Content-Type":i.contentType,"Content-Disposition":`inline; filename="${i.filename}"`,"Cache-Control":"public, max-age=31536000, immutable"}})}catch(e){return console.error("File retrieval error:",e),d.NextResponse.json({error:"Failed to retrieve file"},{status:500})}}let u=new n.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/files/[fileId]/route",pathname:"/api/files/[fileId]",filename:"route",bundlePath:"app/api/files/[fileId]/route"},resolvedPagePath:"/Users/meneer.groot/GitHub/LOOPCHAN/app/api/files/[fileId]/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:p,staticGenerationAsyncStorage:m,serverHooks:c}=u,f="/api/files/[fileId]/route";function y(){return(0,r.patchFetch)({serverHooks:c,staticGenerationAsyncStorage:m})}},75637:(e,t,i)=>{i.d(t,{$B:()=>m,SO:()=>p,jz:()=>u,n5:()=>s});var a=i(11185),n=i.n(a);let o=new(n()).Schema({email:{type:String,required:!0,unique:!0,lowercase:!0,trim:!0},password:{type:String,required:!0},name:{type:String,default:"Anonymous"},createdAt:{type:Date,default:Date.now}},{timestamps:!0}),r=new(n()).Schema({id:{type:String,required:!0,unique:!0},threadId:{type:String,required:!0,index:!0},content:{type:String,default:null},imageFileId:{type:n().Schema.Types.ObjectId,ref:"File",default:null},videoFileId:{type:n().Schema.Types.ObjectId,ref:"File",default:null},authorId:{type:n().Schema.Types.ObjectId,ref:"User",required:!0},isAnonymous:{type:Boolean,default:!0},timestamp:{type:Date,default:Date.now,index:!0}},{timestamps:!0}),d=new(n()).Schema({id:{type:String,required:!0,unique:!0},slug:{type:String,required:!0,unique:!0,index:!0},title:{type:String,required:!0},opPostId:{type:String,required:!0},authorId:{type:n().Schema.Types.ObjectId,ref:"User",required:!0},replyCount:{type:Number,default:0},imageCount:{type:Number,default:0},videoCount:{type:Number,default:0},lastActivity:{type:Date,default:Date.now,index:!0},createdAt:{type:Date,default:Date.now,index:!0}},{timestamps:!0}),l=new(n()).Schema({filename:{type:String,required:!0},contentType:{type:String,required:!0},size:{type:Number,required:!0},uploadedAt:{type:Date,default:Date.now,index:!0},uploadedBy:{type:n().Schema.Types.ObjectId,ref:"User",required:!0},gridFSFileId:{type:n().Schema.Types.ObjectId,required:!0},isDeleted:{type:Boolean,default:!1}},{timestamps:!0}),s=n().models.User||n().model("User",o),u=n().models.Thread||n().model("Thread",d),p=n().models.Post||n().model("Post",r),m=n().models.File||n().model("File",l)},14184:(e,t,i)=>{let a;i.d(t,{ZP:()=>u,rW:()=>s});var n=i(38013);let o=process.env.MONGODB_URI||"mongodb://localhost:27017",r=null,d=null;async function l(){return d||(d=(await a).db()),d}async function s(){if(!r){let e=await l();r=new n.GridFSBucket(e,{bucketName:"files"})}return r}let u=a=new n.MongoClient(o,{}).connect()},29342:(e,t,i)=>{i.d(t,{Ho:()=>m,Ij:()=>u,OL:()=>c,Oo:()=>s,WN:()=>f,gK:()=>p,ky:()=>y});var a=i(14184),n=i(75637),o=i(11185),r=i.n(o),d=i(76162);async function l(){if(!r().connections[0].readyState){if(!process.env.MONGODB_URI)throw Error("MONGODB_URI is not defined");await r().connect(process.env.MONGODB_URI)}}async function s(){await l();let e=await n.jz.find({}).sort({createdAt:-1}).limit(100).lean();return{threads:await Promise.all(e.map(async e=>{let t=await n.SO.findOne({id:e.opPostId}).lean();return{...e,op:t?{content:t.content||null,image:t.imageFileId?`/api/files/${t.imageFileId}`:void 0,video:t.videoFileId?`/api/files/${t.videoFileId}`:void 0,authorWallet:"anonymous",timestamp:t.timestamp}:null}})),totalThreads:e.length,lastUpdated:new Date().toISOString()}}async function u(e){await l();let t=await n.jz.findOne({id:e}).lean();if(!t)return null;let i=await n.SO.findOne({id:t.opPostId}).lean(),a=await n.SO.find({threadId:e}).sort({timestamp:1}).lean();return{...t,op:i?{content:i.content,image:i.imageFileId?`/api/files/${i.imageFileId}`:void 0,video:i.videoFileId?`/api/files/${i.videoFileId}`:void 0,authorWallet:"anonymous",timestamp:i.timestamp}:null,replies:a.map(e=>({id:e.id,timestamp:e.timestamp,content:e.content,image:e.imageFileId?`/api/files/${e.imageFileId}`:void 0,video:e.videoFileId?`/api/files/${e.videoFileId}`:void 0,authorWallet:"anonymous",isAnonymous:e.isAnonymous,mediaFiles:[]}))}}async function p(e){await l();let t=`post_${Date.now()}_${Math.random().toString(36).substring(2,15)}`,i=new n.SO({id:t,threadId:e.id,content:e.op.content||null,imageFileId:e.op.image||null,videoFileId:e.op.video||null,authorId:e.authorId,isAnonymous:!0,timestamp:e.op.timestamp});await i.save();let a=new n.jz({id:e.id,slug:e.slug,title:e.title,opPostId:t,authorId:e.authorId,replyCount:0,imageCount:e.op.image?1:0,videoCount:e.op.video?1:0,lastActivity:new Date,createdAt:new Date});await a.save();let o=await n.jz.countDocuments({});if(o>100)for(let e of(await n.jz.find({}).sort({createdAt:1}).limit(o-100).lean()))await n.SO.deleteMany({threadId:e.id}),await n.jz.deleteOne({id:e.id});return a}async function m(e,t){await l();let i=new n.SO({id:t.id,threadId:e,content:t.content||null,imageFileId:t.image||null,videoFileId:t.video||null,authorId:t.authorId,isAnonymous:!0,timestamp:t.timestamp});await i.save();let a=await n.jz.findOne({id:e});return a&&(a.replyCount=(a.replyCount||0)+1,t.image&&(a.imageCount=(a.imageCount||0)+1),t.video&&(a.videoCount=(a.videoCount||0)+1),a.lastActivity=new Date,await a.save()),i}async function c(e,t,i,o){await l();let r=(await (0,a.rW)()).openUploadStream(t,{contentType:i});d.Readable.from(e).pipe(r),await new Promise((e,t)=>{r.on("finish",e),r.on("error",t)});let s=new n.$B({filename:t,contentType:i,size:e.length,uploadedAt:new Date,uploadedBy:o,gridFSFileId:r.id});return await s.save(),s._id.toString()}async function f(e){await l();let t=await n.$B.findOne({_id:e,isDeleted:!1});return(t||(t=await n.$B.findOne({gridFSFileId:e,isDeleted:!1})),t)?{stream:(await (0,a.rW)()).openDownloadStream(t.gridFSFileId),contentType:t.contentType,filename:t.filename}:null}async function y(){await l();let e=new Date;e.setDate(e.getDate()-30);let t=await n.$B.find({uploadedAt:{$lt:e},isDeleted:!1}),i=await (0,a.rW)(),o=0;for(let e of t)try{await i.delete(e.gridFSFileId),e.isDeleted=!0,await e.save(),o++}catch(t){console.error(`Failed to delete file ${e.gridFSFileId}:`,t)}return o}}};var t=require("../../../../webpack-runtime.js");t.C(e);var i=e=>t(t.s=e),a=t.X(0,[9276,5972],()=>i(16105));module.exports=a})();