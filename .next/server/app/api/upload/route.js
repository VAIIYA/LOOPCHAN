"use strict";(()=>{var e={};e.id=5998,e.ids=[5998],e.modules={38013:e=>{e.exports=require("mongodb")},11185:e=>{e.exports=require("mongoose")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},80665:e=>{e.exports=require("dns")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},76162:e=>{e.exports=require("stream")},82452:e=>{e.exports=require("tls")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},78981:(e,t,i)=>{i.r(t),i.d(t,{originalPathname:()=>w,patchFetch:()=>v,requestAsyncStorage:()=>g,routeModule:()=>c,serverHooks:()=>f,staticGenerationAsyncStorage:()=>y});var a={};i.r(a),i.d(a,{POST:()=>m});var r=i(49303),n=i(88716),o=i(60670),s=i(87070),d=i(95456),l=i(29342);let p=["video/webm","video/mp4","video/quicktime"],u=["image/jpeg","image/jpg","image/png","image/gif","image/webp",...p];async function m(e){try{let t=await (0,d.I8)();if(!t||!t.user?.id)return s.NextResponse.json({error:"Authentication required"},{status:401});let i=(await e.formData()).get("file");if(!i)return s.NextResponse.json({error:"No file provided"},{status:400});if(!u.includes(i.type))return s.NextResponse.json({error:`File type not allowed. Allowed types: ${u.join(", ")}`},{status:400});let a=p.includes(i.type),r=a?10485760:5242880;if(i.size>r)return s.NextResponse.json({error:`File too large. Maximum size for ${a?"videos":"images"}: ${r/1048576}MB`},{status:400});let n=Date.now(),o=Math.random().toString(36).substring(2,15),m=i.name.split(".").pop()?.toLowerCase(),c={"image/jpeg":"jpg","image/jpg":"jpg","image/png":"png","image/gif":"gif","image/webp":"webp","video/webm":"webm","video/mp4":"mp4","video/quicktime":"mov"}[i.type],g=`${n}-${o}.${m===c?m:c}`,y=await i.arrayBuffer(),f=Buffer.from(y),w=await (0,l.OL)(f,g,i.type,t.user.id);return s.NextResponse.json({url:`/api/files/${w}`,blobId:w,fileId:w,filename:g,fileType:i.type,isVideo:a})}catch(e){return console.error("Upload error:",e),s.NextResponse.json({error:"Failed to upload file"},{status:500})}}let c=new r.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/upload/route",pathname:"/api/upload",filename:"route",bundlePath:"app/api/upload/route"},resolvedPagePath:"/Users/meneer.groot/GitHub/LOOPCHAN/app/api/upload/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:g,staticGenerationAsyncStorage:y,serverHooks:f}=c,w="/api/upload/route";function v(){return(0,o.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:y})}},95456:(e,t,i)=>{i.d(t,{I8:()=>g,handlers:()=>c});var a=i(68372),r=i(27600),n=i(22058),o=i(64704),s=i(14184),d=i(98691),l=i(75637),p=i(11185),u=i.n(p);async function m(){if(!u().connections[0].readyState){if(!process.env.MONGODB_URI)throw Error("MONGODB_URI is not defined");await u().connect(process.env.MONGODB_URI)}}let{handlers:c,auth:g,signIn:y,signOut:f}=(0,a.ZP)({adapter:(0,o.dJ)(s.ZP),providers:[(0,r.Z)({credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)return null;await m();let t="string"==typeof e.email?e.email.toLowerCase():String(e.email).toLowerCase(),i="string"==typeof e.password?e.password:String(e.password),a=await l.n5.findOne({email:t});return a&&await d.ZP.compare(i,a.password)?{id:a._id.toString(),email:a.email,name:a.name}:null}}),(0,n.Z)({server:{host:process.env.SMTP_HOST,port:Number(process.env.SMTP_PORT),auth:{user:process.env.SMTP_USER,pass:process.env.SMTP_PASSWORD}},from:process.env.SMTP_FROM||"noreply@loopchan.vercel.app"})],session:{strategy:"jwt"},pages:{signIn:"/auth/signin"},callbacks:{jwt:async({token:e,user:t})=>(t&&(e.id=t.id,e.email=t.email),e),session:async({session:e,token:t})=>(e.user&&(e.user.id=t.id),e)},secret:process.env.NEXTAUTH_SECRET})},75637:(e,t,i)=>{i.d(t,{$B:()=>m,SO:()=>u,jz:()=>p,n5:()=>l});var a=i(11185),r=i.n(a);let n=new(r()).Schema({email:{type:String,required:!0,unique:!0,lowercase:!0,trim:!0},password:{type:String,required:!0},name:{type:String,default:"Anonymous"},createdAt:{type:Date,default:Date.now}},{timestamps:!0}),o=new(r()).Schema({id:{type:String,required:!0,unique:!0},threadId:{type:String,required:!0,index:!0},content:{type:String,default:null},imageFileId:{type:r().Schema.Types.ObjectId,ref:"File",default:null},videoFileId:{type:r().Schema.Types.ObjectId,ref:"File",default:null},authorId:{type:r().Schema.Types.ObjectId,ref:"User",required:!0},isAnonymous:{type:Boolean,default:!0},timestamp:{type:Date,default:Date.now,index:!0}},{timestamps:!0}),s=new(r()).Schema({id:{type:String,required:!0,unique:!0},slug:{type:String,required:!0,unique:!0,index:!0},title:{type:String,required:!0},opPostId:{type:String,required:!0},authorId:{type:r().Schema.Types.ObjectId,ref:"User",required:!0},replyCount:{type:Number,default:0},imageCount:{type:Number,default:0},videoCount:{type:Number,default:0},lastActivity:{type:Date,default:Date.now,index:!0},createdAt:{type:Date,default:Date.now,index:!0}},{timestamps:!0}),d=new(r()).Schema({filename:{type:String,required:!0},contentType:{type:String,required:!0},size:{type:Number,required:!0},uploadedAt:{type:Date,default:Date.now,index:!0},uploadedBy:{type:r().Schema.Types.ObjectId,ref:"User",required:!0},gridFSFileId:{type:r().Schema.Types.ObjectId,required:!0},isDeleted:{type:Boolean,default:!1}},{timestamps:!0}),l=r().models.User||r().model("User",n),p=r().models.Thread||r().model("Thread",s),u=r().models.Post||r().model("Post",o),m=r().models.File||r().model("File",d)},14184:(e,t,i)=>{let a;i.d(t,{ZP:()=>p,rW:()=>l});var r=i(38013);let n=process.env.MONGODB_URI||"mongodb://localhost:27017",o=null,s=null;async function d(){return s||(s=(await a).db()),s}async function l(){if(!o){let e=await d();o=new r.GridFSBucket(e,{bucketName:"files"})}return o}let p=a=new r.MongoClient(n,{}).connect()},29342:(e,t,i)=>{i.d(t,{Ho:()=>m,Ij:()=>p,OL:()=>c,Oo:()=>l,WN:()=>g,gK:()=>u,ky:()=>y});var a=i(14184),r=i(75637),n=i(11185),o=i.n(n),s=i(76162);async function d(){if(!o().connections[0].readyState){if(!process.env.MONGODB_URI)throw Error("MONGODB_URI is not defined");await o().connect(process.env.MONGODB_URI)}}async function l(){await d();let e=await r.jz.find({}).sort({createdAt:-1}).limit(100).lean();return{threads:await Promise.all(e.map(async e=>{let t=await r.SO.findOne({id:e.opPostId}).lean();return{...e,op:t?{content:t.content||null,image:t.imageFileId?`/api/files/${t.imageFileId}`:void 0,video:t.videoFileId?`/api/files/${t.videoFileId}`:void 0,authorWallet:"anonymous",timestamp:t.timestamp}:null}})),totalThreads:e.length,lastUpdated:new Date().toISOString()}}async function p(e){await d();let t=await r.jz.findOne({id:e}).lean();if(!t)return null;let i=await r.SO.findOne({id:t.opPostId}).lean(),a=await r.SO.find({threadId:e}).sort({timestamp:1}).lean();return{...t,op:i?{content:i.content,image:i.imageFileId?`/api/files/${i.imageFileId}`:void 0,video:i.videoFileId?`/api/files/${i.videoFileId}`:void 0,authorWallet:"anonymous",timestamp:i.timestamp}:null,replies:a.map(e=>({id:e.id,timestamp:e.timestamp,content:e.content,image:e.imageFileId?`/api/files/${e.imageFileId}`:void 0,video:e.videoFileId?`/api/files/${e.videoFileId}`:void 0,authorWallet:"anonymous",isAnonymous:e.isAnonymous,mediaFiles:[]}))}}async function u(e){await d();let t=`post_${Date.now()}_${Math.random().toString(36).substring(2,15)}`,i=new r.SO({id:t,threadId:e.id,content:e.op.content||null,imageFileId:e.op.image||null,videoFileId:e.op.video||null,authorId:e.authorId,isAnonymous:!0,timestamp:e.op.timestamp});await i.save();let a=new r.jz({id:e.id,slug:e.slug,title:e.title,opPostId:t,authorId:e.authorId,replyCount:0,imageCount:e.op.image?1:0,videoCount:e.op.video?1:0,lastActivity:new Date,createdAt:new Date});await a.save();let n=await r.jz.countDocuments({});if(n>100)for(let e of(await r.jz.find({}).sort({createdAt:1}).limit(n-100).lean()))await r.SO.deleteMany({threadId:e.id}),await r.jz.deleteOne({id:e.id});return a}async function m(e,t){await d();let i=new r.SO({id:t.id,threadId:e,content:t.content||null,imageFileId:t.image||null,videoFileId:t.video||null,authorId:t.authorId,isAnonymous:!0,timestamp:t.timestamp});await i.save();let a=await r.jz.findOne({id:e});return a&&(a.replyCount=(a.replyCount||0)+1,t.image&&(a.imageCount=(a.imageCount||0)+1),t.video&&(a.videoCount=(a.videoCount||0)+1),a.lastActivity=new Date,await a.save()),i}async function c(e,t,i,n){await d();let o=(await (0,a.rW)()).openUploadStream(t,{contentType:i});s.Readable.from(e).pipe(o),await new Promise((e,t)=>{o.on("finish",e),o.on("error",t)});let l=new r.$B({filename:t,contentType:i,size:e.length,uploadedAt:new Date,uploadedBy:n,gridFSFileId:o.id});return await l.save(),l._id.toString()}async function g(e){await d();let t=await r.$B.findOne({_id:e,isDeleted:!1});return(t||(t=await r.$B.findOne({gridFSFileId:e,isDeleted:!1})),t)?{stream:(await (0,a.rW)()).openDownloadStream(t.gridFSFileId),contentType:t.contentType,filename:t.filename}:null}async function y(){await d();let e=new Date;e.setDate(e.getDate()-30);let t=await r.$B.find({uploadedAt:{$lt:e},isDeleted:!1}),i=await (0,a.rW)(),n=0;for(let e of t)try{await i.delete(e.gridFSFileId),e.isDeleted=!0,await e.save(),n++}catch(t){console.error(`Failed to delete file ${e.gridFSFileId}:`,t)}return n}}};var t=require("../../../webpack-runtime.js");t.C(e);var i=e=>t(t.s=e),a=t.X(0,[9276,5972,8691,2694],()=>i(78981));module.exports=a})();